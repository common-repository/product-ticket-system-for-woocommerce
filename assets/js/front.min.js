// Chat functionality
(function ($) {
  "use strict";

  $(document).ready(function () {
    var input_text = document.getElementById("chattext");
    if (input_text) {
      $("body").on("click", ".wcpt-chat #chatsend", function (e, input_text) {
        chat_init();
      });

      // Execute a function when the user presses a key on the keyboard
      input_text.addEventListener("keypress", function (event, input_text) {
        // If the user presses the "Enter" key on the keyboard
        if (event.key === "Enter") {
          // Cancel the default action, if needed
          event.preventDefault();
          chat_init();
        }
      });
    }

    // Upload button text change as per attachment name.
    let _replacetext_new = "Upload a new image";
    let _filename_new = "Upload a new image";
    $("#second_featured_img").change(function (e) {
      let $in = $(this);
      if ($in[0].files[0].size > 2000000) {
        alert("The maximum file size supported is 2MB");
        $in.val("");
        _filename_new = "Upload a new image";
        // $(".prev-name").html($(".prev-name").html().replace(_replacetext_new, "Upload a new image" ));
      } else {
        _filename_new = $in[0].files[0].name;
      }

      $(".prev-name").html(
        $(".prev-name").html().replace(_replacetext_new, _filename_new)
      );
      _replacetext_new = _filename_new;
    });

    // Upload button text change as per attachment name.
    // let _replacetext = "Choose Image";
    let _filename;
    $("#chat_attachment").change(function (e) {
      let $in = $(this);
      if ($in[0].files[0] != undefined) {
        _filename = $in[0].files[0].name;
        $(".upload-img-btn-span").text(_filename);
      }
      // _replacetext = _filename;
    });
  });
})(jQuery);

var $ = jQuery.noConflict();

// Chat function init
function chat_init(input_text) {
  let chattext = jQuery("#chattext").val();
  let agentname = jQuery(".agent-name").val();
  const monthNames = [
    "Jan",
    "Feb",
    "Mar",
    "Apr",
    "May",
    "Jun",
    "Jul",
    "Aug",
    "Sep",
    "Oct",
    "Nov",
    "Dec",
  ];

  var days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  // const today = new Date();
  // var visitortime = new Date();
  // var visitortimezone = "GMT " + -visitortime.getTimezoneOffset()/60;

  var tz = jstz.determine(); // Determines the time zone of the browser client
  var visitortimezone = tz.name();

  const today = new Date();
  const yyyy = today.getFullYear();
  let mm = today.getMonth(); // Months start at 0!
  let dd = today.getDate();
  let fulldate =
    days[today.getDay()] + " " + dd + " " + monthNames[mm] + " " + yyyy;

  let chattextdiv =
    '<div class="chat outgoing"><div class="details"><p><span>' +
    agentname +
    "</span>" +
    chattext +
    "<span>" +
    fulldate +
    "</span></p></div></div>";

  let pticket_id = jQuery(".pticket_id").val();
  let incoming_msg = jQuery(".incoming_msg").val();
  let outgoing_mgs = jQuery(".outgoing_mgs").val();
  let in_out = jQuery(".in_out").val();
  let scrollElement = document.getElementById("scroll-box");

  var formData = new FormData();
  let output = false;

  if (document.getElementById("chat_attachment").files.length != 0) {
    let chat_attachment = $("#chat_attachment")[0].files[0];

    _size = chat_attachment.size;
    if (_size > 2000000) {
      alert("The maximum file size supported is 2MB");
      return false;
    }

    var type = chat_attachment.type; // image/jpg, image/png, image/jpeg...
    // allow jpg, png, jpeg, bmp, gif, ico
    var type_reg = /^image\/(jpg|png|jpeg)$/;

    if (type_reg.test(type)) {
      formData.append("img", chat_attachment);
      let imgsrc = URL.createObjectURL(chat_attachment);

      if (imgsrc) {
        output =
          '<div class="chat outgoing ">' +
          '<div class="details">' +
          '<a href="' +
          imgsrc +
          '" target="_blank"><img src="' +
          imgsrc +
          '" ></a>' +
          "</div>" +
          "</div>";
      }
    } else {
      alert(
        "Only files with the following extensions are allowed: jpg, jpeg and png"
      );
      return false;
    }
  }

  formData.append("action", "chatajax");
  formData.append("post_id", pticket_id);
  formData.append("incoming_msg", incoming_msg);
  formData.append("outgoing_mgs", outgoing_mgs);
  formData.append("in_out", in_out);
  formData.append("message", chattext);
  formData.append("timezone", visitortimezone);
  formData.append("ajaxnonce", wcptvar.ajaxnonce);

  if (!output && !chattext) {
    return;
  }

  $.ajax({
    url: wcptvar.wcptadminurl,
    type: "post",
    data: formData,
    contentType: false,
    processData: false,
    beforeSend: function (xhr) {
      $("#chattext").val("");
      document.getElementById("chat_attachment").value = "";
      $(".upload-img-btn-span").text("Choose Image");
      if (chattext) {
        $(".chat-box").append(chattextdiv);
      }
      if (output) {
        $(".chat-box").append(output);
      }

      scrollElement.scrollTop = scrollElement.scrollHeight;
    },
    success: function (res) {
      console.log(res);
    },
  });
}

// Create Product Ticket post type
jQuery(document).on("submit", "#ptform", function (e) {
  e.preventDefault();

  var formData = new FormData(this);
  if (formData.get("closeticket") == "closeticket") {
    if (!confirm("Are you sure you want to close this ticket?")) {
      return;
    }
  } else {
    $("#ptform").prop("disabled", true);
  }

  // formData.delete("second_featured_img");
  if (document.getElementById("second_featured_img")) {
    if (document.getElementById("second_featured_img").files.length != 0) {
      formData.append(
        "second_featured_img",
        $("#second_featured_img")[0].files[0]
      );
      let imgsrc = URL.createObjectURL(
        jQuery("#second_featured_img")[0].files[0]
      );
    } else {
      formData.delete("second_featured_img");
    }
  }

  formData.append("action", "ysl_product_ticket");

  jQuery.ajax({
    type: "post",
    dataType: "json",
    url: wcptvar.wcptadminurl,
    data: formData,
    processData: false,
    contentType: false,
    beforeSend: function () {
      $("#ptform .loader").show();
    },
    success: function (res) {
      $("#ptform .loader").hide();
      $("span.error").html("");
      if (res.status == "true") {
        if (res.statusUpdate != undefined) {
          $("span.success").html("Your ticket has been closed");
          setTimeout(() => {
            location.reload();
          }, 5000);
        } else {
          $("span.success").html("Your ticket has been created");
          setTimeout(() => {
            window.location.href = wcptvar.mytickets;
          }, 5000);
        }
      } else {
        $("#ptform").prop("disabled", false);
        for (var key in res.error) {
          var consts = {};
          consts["key"] = key;
          $("span." + key).html(res.error[consts.key]);
        }
      }
    },
  });
  return false;
});

$(document).on("change", "#order", function (e) {
  var optionSelected = $("option:selected", this);
  var valueSelected = this.value;
  const nonceValue = document.querySelector('input[name="_wpnonce"]').value;

  let data = {
    action: "orders_products",
    nonce: nonceValue,
    valueSelected: valueSelected,
  };

  if (valueSelected) {
    $.ajax({
      url: wcptvar.wcptadminurl,
      type: "post",
      dataType: "json",
      data: data,
      beforeSend: function (xhr) {},
      success: function (res) {
        $("#wcpt-products").html(res.optionHtml);
      },
    });
  } else {
    $("#wcpt-products").html('<option value=""> Select Product </option>');
  }
});
